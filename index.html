<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAWLYN Limited - Inventory Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Login Screen */
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .logo-container {
            margin-bottom: 30px;
        }

        .logo-container img {
            max-width: 250px;
            height: auto;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .container.active {
            display: block;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            max-width: 150px;
            height: auto;
        }

        .header-text h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header-text p {
            color: #666;
            font-size: 1em;
        }

        .header-right {
            text-align: right;
        }

        .user-info {
            color: #666;
            margin-bottom: 10px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .content.active {
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="file"], input[type="date"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .location-breakdown {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .location-breakdown h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .location-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .location-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .location-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .location-stat {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .location-stat label {
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }

        .location-stat .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-in-stock {
            background: #d4edda;
            color: #155724;
        }

        .status-low-stock {
            background: #fff3cd;
            color: #856404;
        }

        .status-out-of-stock {
            background: #f8d7da;
            color: #721c24;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .download-template {
            background: #17a2b8;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .price-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .price-summary h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }

        .price-row.total {
            border-top: 2px solid #667eea;
            margin-top: 10px;
            padding-top: 10px;
            font-weight: bold;
            font-size: 20px;
            color: #667eea;
        }

        .discount-input-group {
            display: flex;
            gap: 10px;
        }

        .discount-input-group input {
            flex: 1;
        }

        .discount-input-group select {
            flex: 0 0 100px;
        }

        .date-display {
            color: #666;
            font-size: 14px;
            font-style: italic;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .report-container, .report-container * {
                visibility: visible;
            }
            .report-container {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="logo-container">
            <img src="logo.jpg" alt="WAWLYN Logo">
        </div>
        <h2 style="color: #667eea; margin-bottom: 30px;">Inventory Management System</h2>
        <form class="login-form" onsubmit="login(event)">
            <input type="email" id="loginEmail" placeholder="üìß Email Address" required>
            <input type="password" id="loginPassword" placeholder="üîí Password" required>
            <button type="submit" class="btn" style="width: 100%; margin-top: 10px;">Login</button>
        </form>
        <p style="margin-top: 20px; color: #666; font-size: 14px;">
            Default credentials:<br>
            Email: admin@wawlyn.com<br>
            Password: admin123
        </p>
    </div>

    <!-- Main Application -->
    <div class="container" id="mainApp">
        <div class="header">
            <div class="header-left">
                <img src="logo.jpg" alt="WAWLYN Logo" class="header-logo">
                <div class="header-text">
                    <h1>WAWLYN Limited</h1>
                    <p>Inventory Management System</p>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info" id="userInfo">üë§ Logged in as: admin@wawlyn.com</div>
                <button class="logout-btn" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('inventory')">üì¶ Inventory</button>
            <button class="tab" onclick="showTab('sales')">üí∞ Sales</button>
            <button class="tab" onclick="showTab('transfer')">üîÑ Transfer</button>
            <button class="tab" onclick="showTab('reports')">üìà Reports</button>
            <button class="tab" onclick="showTab('import')">üì• Import Data</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="content active">
            <h2>Dashboard Overview</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Items</h3>
                    <div class="value" id="totalItems">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Stock</h3>
                    <div class="value" id="totalStock">0</div>
                </div>
                <div class="stat-card">
                    <h3>Low Stock Items</h3>
                    <div class="value" id="lowStockItems">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Value</h3>
                    <div class="value" id="totalValue">TZS 0</div>
                </div>
            </div>

            <div class="location-breakdown" id="locationBreakdown">
                <h3>üìç Breakdown by Location</h3>
                <div id="locationCards"></div>
            </div>

            <h3 style="margin-top: 30px;">Recent Activities</h3>
            <div id="recentActivities" style="margin-top: 15px;">
                <p style="color: #666;">No recent activities</p>
            </div>
        </div>

        <!-- Inventory -->
        <div id="inventory" class="content">
            <h2>Inventory Management</h2>
            <button class="btn" onclick="showAddItemModal()">‚ûï Add New Item</button>
            <button class="btn btn-success" onclick="showAdjustPriceModal()">üíµ Adjust Prices</button>
            
            <div class="form-grid" style="margin-top: 20px;">
                <div class="form-group">
                    <label>Filter by Location</label>
                    <select id="inventoryLocationFilter" onchange="filterInventoryByLocation()">
                        <option value="">All Locations</option>
                    </select>
                </div>
            </div>
            
            <input type="text" class="search-box" id="searchInventory" placeholder="üîç Search by name, variant, or location..." onkeyup="searchInventory()">

            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>Min Stock</th>
                        <th>Status</th>
                        <th>Location</th>
                        <th>Price</th>
                        <th>Added Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">No items in inventory</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Sales -->
        <div id="sales" class="content">
            <h2>Record Sales</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Select Item</label>
                    <select id="saleItem" onchange="calculateSaleTotal()">
                        <option value="">Choose item...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity Sold</label>
                    <input type="number" id="saleQuantity" min="1" placeholder="Enter quantity" onchange="calculateSaleTotal()">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <select id="saleLocation">
                        <option value="">Choose location...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Transaction Date</label>
                    <input type="date" id="saleDate">
                </div>
            </div>

            <div class="form-group">
                <label>Discount (Optional)</label>
                <div class="discount-input-group">
                    <input type="number" id="discountValue" min="0" placeholder="Enter discount amount" onchange="calculateSaleTotal()">
                    <select id="discountType" onchange="calculateSaleTotal()">
                        <option value="percent">%</option>
                        <option value="fixed">TZS</option>
                    </select>
                </div>
            </div>

            <div class="price-summary" id="salePriceSummary" style="display: none;">
                <h4>üí∞ Sale Summary</h4>
                <div class="price-row">
                    <span>Item:</span>
                    <span id="summaryItem">-</span>
                </div>
                <div class="price-row">
                    <span>Quantity:</span>
                    <span id="summaryQuantity">-</span>
                </div>
                <div class="price-row">
                    <span>Unit Price:</span>
                    <span id="summaryUnitPrice">TZS 0</span>
                </div>
                <div class="price-row">
                    <span>Subtotal:</span>
                    <span id="summarySubtotal">TZS 0</span>
                </div>
                <div class="price-row" id="discountRow" style="display: none; color: #28a745;">
                    <span>Discount:</span>
                    <span id="summaryDiscount">TZS 0</span>
                </div>
                <div class="price-row total">
                    <span>Total:</span>
                    <span id="summaryTotal">TZS 0</span>
                </div>
            </div>

            <button class="btn btn-success" onclick="recordSale()" style="margin-top: 15px;">‚úÖ Record Sale</button>

            <h3 style="margin-top: 30px;">Sales History</h3>
            <input type="text" class="search-box" id="searchSales" placeholder="üîç Search sales by item name, variant, or location..." onkeyup="searchSales()">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Discount</th>
                        <th>Location</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="salesBody">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">No sales recorded</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Transfer -->
        <div id="transfer" class="content">
            <h2>Transfer Items</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Select Item</label>
                    <select id="transferItem" onchange="updateTransferLocations()">
                        <option value="">Choose item...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="transferQuantity" min="1" placeholder="Enter quantity">
                </div>
                <div class="form-group">
                    <label>From Location</label>
                    <select id="transferFrom">
                        <option value="">Choose location...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>To Location</label>
                    <select id="transferTo">
                        <option value="">Choose location...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Transfer Date</label>
                    <input type="date" id="transferDate">
                </div>
            </div>
            <button class="btn btn-warning" onclick="transferItems()">üîÑ Transfer Items</button>

            <h3 style="margin-top: 30px;">Transfer History</h3>
            <input type="text" class="search-box" id="searchTransfers" placeholder="üîç Search transfers by item name, variant, or location..." onkeyup="searchTransfers()">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transferBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">No transfers recorded</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Reports -->
        <div id="reports" class="content">
            <h2>Reports</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Report Date</label>
                    <input type="date" id="reportDate">
                </div>
                <div class="form-group">
                    <label>Report Location</label>
                    <select id="reportLocation">
                        <option value="">All Locations</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-success" onclick="generateEODReport()">üìÑ Generate End of Day Report</button>
            <button class="btn" onclick="generateInventoryReport()">üìã Full Inventory Report</button>
            <button class="btn btn-warning" onclick="generateSalesReport()">üí∞ Sales Report</button>
            
            <div id="reportContainer" class="report-container" style="margin-top: 30px;"></div>
        </div>

        <!-- Import Data -->
        <div id="import" class="content">
            <h2>Import Inventory Data</h2>
            
            <div class="download-template">
                <h3 style="margin-bottom: 10px;">üì• Download CSV Template</h3>
                <p style="margin-bottom: 15px;">Download the template file and fill it with your inventory data</p>
                <button class="btn" onclick="downloadTemplate()">Download Template</button>
            </div>

            <div class="form-group">
                <label>Upload CSV File</label>
                <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(event)">
            </div>

            <p style="color: #666; margin-top: 10px; margin-bottom: 20px;">
                <strong>Format:</strong> Name, Variant, Quantity, Min Stock, Status, Location, Price<br>
                <strong>Example:</strong> iPhone 14 Pro, 128GB Black, 10, 5, In Stock, Main Store, 45000
            </p>

            <div style="border-top: 2px solid #ddd; padding-top: 20px; margin-top: 30px;">
                <h3 style="color: #dc3545; margin-bottom: 15px;">‚ö†Ô∏è Data Management</h3>
                <button class="btn btn-success" onclick="exportData()">üì§ Export All Data (Backup)</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                <p style="color: #666; margin-top: 10px; font-size: 14px;">
                    <strong>Export:</strong> Download all your inventory, sales, and transfer data as JSON backup<br>
                    <strong>Clear All:</strong> Delete all records from the system (use with caution!)
                </p>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addItemModal')">&times;</span>
            <h2>Add New Item</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="itemName" placeholder="Enter item name">
            </div>
            <div class="form-group">
                <label>Variant</label>
                <input type="text" id="itemVariant" placeholder="Enter variant (e.g., 128GB Black)">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="itemQuantity" min="0" placeholder="Enter quantity">
            </div>
            <div class="form-group">
                <label>Min Stock</label>
                <input type="number" id="itemMinStock" min="0" placeholder="Minimum stock level">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="itemLocation" placeholder="Store location">
            </div>
            <div class="form-group">
                <label>Price (TZS)</label>
                <input type="number" id="itemPrice" min="0" step="0.01" placeholder="Enter price">
            </div>
            <button class="btn btn-success" onclick="addItem()">Add Item</button>
            <button class="btn btn-secondary" onclick="closeModal('addItemModal')">Cancel</button>
        </div>
    </div>

    <!-- Adjust Price Modal -->
    <div id="adjustPriceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('adjustPriceModal')">&times;</span>
            <h2>Adjust Prices</h2>
            <div class="form-group">
                <label>Select Item</label>
                <select id="priceAdjustItem">
                    <option value="">Choose item...</option>
                </select>
            </div>
            <div class="form-group">
                <label>New Price (TZS)</label>
                <input type="number" id="newPrice" min="0" step="0.01" placeholder="Enter new price">
            </div>
            <button class="btn btn-success" onclick="adjustPrice()">Update Price</button>
            <button class="btn btn-secondary" onclick="closeModal('adjustPriceModal')">Cancel</button>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="editItemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editItemModal')">&times;</span>
            <h2>Edit Item</h2>
            <input type="hidden" id="editItemId">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="editItemName" placeholder="Enter item name">
            </div>
            <div class="form-group">
                <label>Variant</label>
                <input type="text" id="editItemVariant" placeholder="Enter variant">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="editItemQuantity" min="0" placeholder="Enter quantity">
            </div>
            <div class="form-group">
                <label>Min Stock</label>
                <input type="number" id="editItemMinStock" min="0" placeholder="Minimum stock level">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="editItemLocation" placeholder="Store location">
            </div>
            <div class="form-group">
                <label>Price (TZS)</label>
                <input type="number" id="editItemPrice" min="0" step="0.01" placeholder="Enter price">
            </div>
            <button class="btn btn-success" onclick="updateItem()">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeModal('editItemModal')">Cancel</button>
        </div>
    </div>

    <script>
        // Data storage
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let productCatalog = JSON.parse(localStorage.getItem('productCatalog')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let transfers = JSON.parse(localStorage.getItem('transfers')) || [];
        let activities = JSON.parse(localStorage.getItem('activities')) || [];
        let currentUser = null;

        // Initialize
        window.onload = function() {
            checkLogin();
            setDefaultDate();
        };

        function checkLogin() {
            currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.add('active');
                document.getElementById('userInfo').textContent = 'üë§ Logged in as: ' + currentUser;
                updateDashboard();
                renderInventory();
                renderSales();
                renderTransfers();
                updateSelects();
            } else {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').classList.remove('active');
            }
        }

        function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (email === 'admin@wawlyn.com' && password === 'admin123') {
                localStorage.setItem('currentUser', email);
                currentUser = email;
                addActivity('User logged in: ' + email);
                checkLogin();
            } else {
                alert('Invalid email or password!');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                addActivity('User logged out: ' + currentUser);
                localStorage.removeItem('currentUser');
                currentUser = null;
                checkLogin();
            }
        }

        function setDefaultDate() {
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            
            if (document.getElementById('saleDate')) {
                document.getElementById('saleDate').value = dateStr;
            }
            if (document.getElementById('transferDate')) {
                document.getElementById('transferDate').value = dateStr;
            }
            if (document.getElementById('reportDate')) {
                document.getElementById('reportDate').value = dateStr;
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'sales' || tabName === 'transfer' || tabName === 'reports') {
                setDefaultDate();
            }
        }

        function showAddItemModal() {
            document.getElementById('addItemModal').style.display = 'block';
        }

        function showAdjustPriceModal() {
            document.getElementById('adjustPriceModal').style.display = 'block';
            updatePriceAdjustSelect();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function getOrCreateProduct(name, variant) {
            let product = productCatalog.find(p => p.name === name && p.variant === variant);
            if (!product) {
                product = {
                    productId: Date.now(),
                    name: name,
                    variant: variant
                };
                productCatalog.push(product);
            }
            return product;
        }

        function addItem() {
            const name = document.getElementById('itemName').value;
            const variant = document.getElementById('itemVariant').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const minStock = parseInt(document.getElementById('itemMinStock').value);
            const location = document.getElementById('itemLocation').value;
            const price = parseFloat(document.getElementById('itemPrice').value);

            if (!name || !variant || !location) {
                alert('Please fill all required fields');
                return;
            }

            const product = getOrCreateProduct(name, variant);
            const existingItem = inventory.find(i => 
                i.productId === product.productId && i.location === location
            );

            if (existingItem) {
                alert('This item already exists in this location. Please edit the existing item instead.');
                return;
            }

            const item = {
                id: Date.now(),
                productId: product.productId,
                name: name,
                variant: variant,
                quantity: quantity,
                minStock: minStock,
                location: location,
                price: price,
                dateAdded: new Date().toISOString()
            };

            inventory.push(item);
            saveData();
            addActivity('Added new item: ' + item.name + ' - ' + item.variant + ' at ' + item.location);
            renderInventory();
            updateDashboard();
            updateSelects();
            closeModal('addItemModal');
            clearForm();
            alert('Item added successfully!');
        }

        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemVariant').value = '';
            document.getElementById('itemQuantity').value = '';
            document.getElementById('itemMinStock').value = '';
            document.getElementById('itemLocation').value = '';
            document.getElementById('itemPrice').value = '';
        }

        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                const item = inventory.find(i => i.id === id);
                inventory = inventory.filter(i => i.id !== id);
                saveData();
                addActivity('Deleted item: ' + item.name + ' - ' + item.variant);
                renderInventory();
                updateDashboard();
                updateSelects();
            }
        }

        function getStatus(item) {
            if (item.quantity === 0) return 'Out of Stock';
            if (item.quantity <= item.minStock) return 'Low Stock';
            return 'In Stock';
        }

        function getStatusClass(status) {
            if (status === 'In Stock') return 'status-in-stock';
            if (status === 'Low Stock') return 'status-low-stock';
            return 'status-out-of-stock';
        }

        function renderInventory(filteredItems = null) {
            const tbody = document.getElementById('inventoryBody');
            const itemsToRender = filteredItems || inventory;
            
            if (itemsToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No items in inventory</td></tr>';
                return;
            }

            tbody.innerHTML = itemsToRender.map(item => {
                const status = getStatus(item);
                return '<tr><td>' + item.name + '</td><td>' + item.variant + '</td><td>' + item.quantity + '</td><td>' + item.minStock + '</td><td><span class="status-badge ' + getStatusClass(status) + '">' + status + '</span></td><td>' + item.location + '</td><td>TZS ' + item.price.toLocaleString() + '</td><td class="date-display">' + formatDate(item.dateAdded) + '</td><td><button class="action-btn btn-warning" onclick="editItem(' + item.id + ')" style="background: #ffc107; color: #000;">‚úèÔ∏è Edit</button><button class="action-btn btn-danger" onclick="deleteItem(' + item.id + ')">üóëÔ∏è Delete</button></td></tr>';
            }).join('');
        }

        function filterInventoryByLocation() {
            const selectedLocation = document.getElementById('inventoryLocationFilter').value;
            
            if (!selectedLocation) {
                renderInventory();
                return;
            }
            
            const filtered = inventory.filter(item => item.location === selectedLocation);
            renderInventory(filtered);
        }

        function searchInventory() {
            const searchTerm = document.getElementById('searchInventory').value.toLowerCase();
            const filtered = inventory.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.variant.toLowerCase().includes(searchTerm) ||
                item.location.toLowerCase().includes(searchTerm)
            );
            renderInventory(filtered);
        }

        function searchSales() {
            const searchTerm = document.getElementById('searchSales').value.toLowerCase();
            const filtered = sales.filter(sale => 
                sale.name.toLowerCase().includes(searchTerm) ||
                sale.variant.toLowerCase().includes(searchTerm) ||
                sale.location.toLowerCase().includes(searchTerm)
            );
            renderSales(filtered);
        }

        function searchTransfers() {
            const searchTerm = document.getElementById('searchTransfers').value.toLowerCase();
            const filtered = transfers.filter(transfer => 
                transfer.name.toLowerCase().includes(searchTerm) ||
                transfer.variant.toLowerCase().includes(searchTerm) ||
                transfer.from.toLowerCase().includes(searchTerm) ||
                transfer.to.toLowerCase().includes(searchTerm)
            );
            renderTransfers(filtered);
        }

        function calculateSaleTotal() {
            const itemId = parseInt(document.getElementById('saleItem').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const discountType = document.getElementById('discountType').value;

            if (!itemId || !quantity) {
                document.getElementById('salePriceSummary').style.display = 'none';
                return;
            }

            const item = inventory.find(i => i.id === itemId);
            if (!item) return;

            const subtotal = item.price * quantity;
            let discountAmount = 0;

            if (discountValue > 0) {
                if (discountType === 'percent') {
                    discountAmount = subtotal * (discountValue / 100);
                } else {
                    discountAmount = discountValue;
                }
            }

            const total = subtotal - discountAmount;

            document.getElementById('summaryItem').textContent = item.name + ' - ' + item.variant;
            document.getElementById('summaryQuantity').textContent = quantity;
            document.getElementById('summaryUnitPrice').textContent = 'TZS ' + item.price.toLocaleString();
            document.getElementById('summarySubtotal').textContent = 'TZS ' + subtotal.toLocaleString();
            
            if (discountAmount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                const discountText = discountType === 'percent' 
                    ? '-TZS ' + discountAmount.toLocaleString() + ' (' + discountValue + '%)'
                    : '-TZS ' + discountAmount.toLocaleString();
                document.getElementById('summaryDiscount').textContent = discountText;
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }

            document.getElementById('summaryTotal').textContent = 'TZS ' + total.toLocaleString();
            document.getElementById('salePriceSummary').style.display = 'block';
        }

        function recordSale() {
            const itemId = parseInt(document.getElementById('saleItem').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const location = document.getElementById('saleLocation').value;
            const date = document.getElementById('saleDate').value;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const discountType = document.getElementById('discountType').value;

            if (!itemId || !quantity || !location || !date) {
                alert('Please fill all required fields');
                return;
            }

            const item = inventory.find(i => i.id === itemId && i.location === location);
            if (!item) {
                alert('Item not found in selected location');
                return;
            }

            if (item.quantity < quantity) {
                alert('Insufficient stock! Only ' + item.quantity + ' available');
                return;
            }

            item.quantity -= quantity;
            
            const subtotal = item.price * quantity;
            let discountAmount = 0;

            if (discountValue > 0) {
                if (discountType === 'percent') {
                    discountAmount = subtotal * (discountValue / 100);
                } else {
                    discountAmount = discountValue;
                }
            }

            const sale = {
                id: Date.now(),
                itemId: item.id,
                name: item.name,
                variant: item.variant,
                quantity: quantity,
                price: item.price,
                location: location,
                discountAmount: discountAmount,
                discountType: discountType,
                discountValue: discountValue,
                subtotal: subtotal,
                total: subtotal - discountAmount,
                date: new Date(date).toISOString()
            };

            sales.push(sale);
            saveData();
            
            const discountText = discountAmount > 0 
                ? ' (Discount: ' + (discountType === 'percent' ? discountValue + '%' : 'TZS ' + discountAmount) + ')'
                : '';
            addActivity('Sale recorded: ' + quantity + 'x ' + item.name + ' - ' + item.variant + ' at ' + location + discountText);
            
            renderSales();
            renderInventory();
            updateDashboard();
            
            document.getElementById('saleQuantity').value = '';
            document.getElementById('discountValue').value = '';
            document.getElementById('salePriceSummary').style.display = 'none';
            setDefaultDate();
            
            alert('Sale recorded successfully!');
        }

        function renderSales(filteredSales = null) {
            const tbody = document.getElementById('salesBody');
            const salesToRender = filteredSales || sales;

            if (salesToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No sales recorded</td></tr>';
                return;
            }

            tbody.innerHTML = salesToRender.slice(-50).reverse().map(sale => {
                const discountText = sale.discountAmount > 0 
                    ? (sale.discountType === 'percent' 
                        ? sale.discountValue + '% (TZS ' + sale.discountAmount.toLocaleString() + ')'
                        : 'TZS ' + sale.discountAmount.toLocaleString())
                    : '-';

                return '<tr><td class="date-display">' + formatDate(sale.date) + '</td><td>' + sale.name + '</td><td>' + sale.variant + '</td><td>' + sale.quantity + '</td><td>TZS ' + sale.price.toLocaleString() + '</td><td style="color: ' + (sale.discountAmount > 0 ? '#28a745' : '#666') + ';">' + discountText + '</td><td>' + sale.location + '</td><td><strong>TZS ' + sale.total.toLocaleString() + '</strong></td><td><button class="action-btn btn-danger" onclick="deleteSale(' + sale.id + ')">üóëÔ∏è Delete</button></td></tr>';
            }).join('');
        }

        function deleteSale(id) {
            if (confirm('Delete this sale record? This will restore the stock quantity.')) {
                const sale = sales.find(s => s.id === id);
                if (sale) {
                    const item = inventory.find(i => i.id === sale.itemId && i.location === sale.location);
                    if (item) {
                        item.quantity += sale.quantity;
                    }
                    
                    sales = sales.filter(s => s.id !== id);
                    saveData();
                    addActivity('Deleted sale: ' + sale.quantity + 'x ' + sale.name + ' - ' + sale.variant);
                    renderSales();
                    renderInventory();
                    updateDashboard();
                }
            }
        }

        function updateTransferLocations() {
            const productId = parseInt(document.getElementById('transferItem').value);
            const fromSelect = document.getElementById('transferFrom');
            const toSelect = document.getElementById('transferTo');
            
            if (!productId) {
                fromSelect.innerHTML = '<option value="">Choose location...</option>';
                toSelect.innerHTML = '<option value="">Choose location...</option>';
                return;
            }

            const locationsWithStock = inventory
                .filter(i => i.productId === productId && i.quantity > 0)
                .map(i => i.location);
            
            const allLocations = [...new Set(inventory.map(i => i.location))];
            
            fromSelect.innerHTML = '<option value="">Choose location...</option>' + 
                locationsWithStock.map(loc => '<option value="' + loc + '">' + loc + '</option>').join('');
            
            toSelect.innerHTML = '<option value="">Choose location...</option>' + 
                allLocations.map(loc => '<option value="' + loc + '">' + loc + '</option>').join('');
        }

        function transferItems() {
            const productId = parseInt(document.getElementById('transferItem').value);
            const quantity = parseInt(document.getElementById('transferQuantity').value);
            const fromLocation = document.getElementById('transferFrom').value;
            const toLocation = document.getElementById('transferTo').value;
            const date = document.getElementById('transferDate').value;

            if (!productId || !quantity || !fromLocation || !toLocation || !date) {
                alert('Please fill all fields');
                return;
            }

            if (fromLocation === toLocation) {
                alert('Cannot transfer to same location');
                return;
            }

            const fromItem = inventory.find(i => i.productId === productId && i.location === fromLocation);
            if (!fromItem || fromItem.quantity < quantity) {
                alert('Insufficient stock in source location');
                return;
            }

            fromItem.quantity -= quantity;

            let toItem = inventory.find(i => i.productId === productId && i.location === toLocation);
            if (toItem) {
                toItem.quantity += quantity;
            } else {
                toItem = {
                    id: Date.now(),
                    productId: productId,
                    name: fromItem.name,
                    variant: fromItem.variant,
                    quantity: quantity,
                    minStock: fromItem.minStock,
                    location: toLocation,
                    price: fromItem.price,
                    dateAdded: new Date().toISOString()
                };
                inventory.push(toItem);
            }

            const transfer = {
                id: Date.now(),
                productId: productId,
                name: fromItem.name,
                variant: fromItem.variant,
                quantity: quantity,
                from: fromLocation,
                to: toLocation,
                date: new Date(date).toISOString()
            };

            transfers.push(transfer);
            saveData();
            addActivity('Transfer: ' + quantity + 'x ' + fromItem.name + ' from ' + fromLocation + ' to ' + toLocation);
            renderTransfers();
            renderInventory();
            updateDashboard();
            updateSelects();
            
            document.getElementById('transferQuantity').value = '';
            document.getElementById('transferItem').value = '';
            document.getElementById('transferFrom').innerHTML = '<option value="">Choose location...</option>';
            document.getElementById('transferTo').innerHTML = '<option value="">Choose location...</option>';
            setDefaultDate();
            alert('Transfer completed successfully!');
        }

        function renderTransfers(filteredTransfers = null) {
            const tbody = document.getElementById('transferBody');
            const transfersToRender = filteredTransfers || transfers;

            if (transfersToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No transfers recorded</td></tr>';
                return;
            }

            tbody.innerHTML = transfersToRender.slice(-50).reverse().map(transfer => 
                '<tr><td class="date-display">' + formatDate(transfer.date) + '</td><td>' + transfer.name + '</td><td>' + transfer.variant + '</td><td>' + transfer.quantity + '</td><td>' + transfer.from + '</td><td>' + transfer.to + '</td><td><button class="action-btn btn-danger" onclick="deleteTransfer(' + transfer.id + ')">üóëÔ∏è Delete</button></td></tr>'
            ).join('');
        }

        function deleteTransfer(id) {
            if (confirm('Delete this transfer record? This will reverse the transfer.')) {
                const transfer = transfers.find(t => t.id === id);
                if (transfer) {
                    const fromItem = inventory.find(i => i.productId === transfer.productId && i.location === transfer.from);
                    const toItem = inventory.find(i => i.productId === transfer.productId && i.location === transfer.to);
                    
                    if (fromItem) fromItem.quantity += transfer.quantity;
                    if (toItem) toItem.quantity -= transfer.quantity;
                    
                    transfers = transfers.filter(t => t.id !== id);
                    saveData();
                    addActivity('Deleted transfer: ' + transfer.quantity + 'x ' + transfer.name + ' from ' + transfer.from + ' to ' + transfer.to);
                    renderTransfers();
                    renderInventory();
                    updateDashboard();
                }
            }
        }

        function updateSelects() {
            const saleItemSelect = document.getElementById('saleItem');
            const itemOptions = inventory.map(item => 
                '<option value="' + item.id + '">' + item.name + ' - ' + item.variant + ' (' + item.location + ')</option>'
            ).join('');
            saleItemSelect.innerHTML = '<option value="">Choose item...</option>' + itemOptions;

            const transferItemSelect = document.getElementById('transferItem');
            const uniqueProducts = [...new Map(productCatalog.map(p => [p.productId, p])).values()];
            const transferOptions = uniqueProducts.map(product => 
                '<option value="' + product.productId + '">' + product.name + ' - ' + product.variant + '</option>'
            ).join('');
            transferItemSelect.innerHTML = '<option value="">Choose item...</option>' + transferOptions;

            const allLocations = [...new Set(inventory.map(i => i.location))];
            const locationOptions = allLocations.map(loc => '<option value="' + loc + '">' + loc + '</option>').join('');
            
            document.getElementById('saleLocation').innerHTML = '<option value="">Choose location...</option>' + locationOptions;
            document.getElementById('reportLocation').innerHTML = '<option value="">All Locations</option>' + locationOptions;
            document.getElementById('inventoryLocationFilter').innerHTML = '<option value="">All Locations</option>' + locationOptions;
        }

        function updatePriceAdjustSelect() {
            const select = document.getElementById('priceAdjustItem');
            const options = inventory.map(item => 
                '<option value="' + item.id + '">' + item.name + ' - ' + item.variant + ' (' + item.location + ') - Current: TZS ' + item.price + '</option>'
            ).join('');
            select.innerHTML = '<option value="">Choose item...</option>' + options;
        }

        function adjustPrice() {
            const itemId = parseInt(document.getElementById('priceAdjustItem').value);
            const newPrice = parseFloat(document.getElementById('newPrice').value);

            if (!itemId || !newPrice) {
                alert('Please select item and enter new price');
                return;
            }

            const item = inventory.find(i => i.id === itemId);
            if (item) {
                const oldPrice = item.price;
                item.price = newPrice;
                addActivity('Price adjusted for ' + item.name + ' - ' + item.variant + ' at ' + item.location + ': TZS ' + oldPrice + ' ‚Üí TZS ' + newPrice);
                saveData();
                renderInventory();
                updateDashboard();
                closeModal('adjustPriceModal');
                alert('Price updated successfully!');
            }
        }

        function editItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemVariant').value = item.variant;
            document.getElementById('editItemQuantity').value = item.quantity;
            document.getElementById('editItemMinStock').value = item.minStock;
            document.getElementById('editItemLocation').value = item.location;
            document.getElementById('editItemPrice').value = item.price;

            document.getElementById('editItemModal').style.display = 'block';
        }

        function updateItem() {
            const id = parseInt(document.getElementById('editItemId').value);
            const item = inventory.find(i => i.id === id);
            
            if (!item) return;

            const oldData = item.name + ' - ' + item.variant;
            
            item.name = document.getElementById('editItemName').value;
            item.variant = document.getElementById('editItemVariant').value;
            item.quantity = parseInt(document.getElementById('editItemQuantity').value);
            item.minStock = parseInt(document.getElementById('editItemMinStock').value);
            item.location = document.getElementById('editItemLocation').value;
            item.price = parseFloat(document.getElementById('editItemPrice').value);

            if (!item.name || !item.variant || !item.location) {
                alert('Please fill all required fields');
                return;
            }

            saveData();
            addActivity('Updated item: ' + oldData + ' ‚Üí ' + item.name + ' - ' + item.variant);
            renderInventory();
            updateDashboard();
            closeModal('editItemModal');
            alert('Item updated successfully!');
        }

        function updateDashboard() {
            document.getElementById('totalItems').textContent = inventory.length;
            document.getElementById('totalStock').textContent = inventory.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('lowStockItems').textContent = inventory.filter(item => item.quantity <= item.minStock).length;
            document.getElementById('totalValue').textContent = 'TZS ' + inventory.reduce((sum, item) => sum + (item.quantity * item.price), 0).toLocaleString();

            const locations = [...new Set(inventory.map(i => i.location))];
            const locationCardsDiv = document.getElementById('locationCards');
            
            if (locations.length === 0) {
                locationCardsDiv.innerHTML = '<p style="color: #666; text-align: center;">No locations yet</p>';
            } else {
                locationCardsDiv.innerHTML = locations.map(location => {
                    const locationItems = inventory.filter(i => i.location === location);
                    const totalItems = locationItems.length;
                    const totalStock = locationItems.reduce((sum, item) => sum + item.quantity, 0);
                    const lowStock = locationItems.filter(item => item.quantity <= item.minStock).length;
                    const totalValue = locationItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    
                    return '<div class="location-card"><h4>üìç ' + location + '</h4><div class="location-stats"><div class="location-stat"><label>Items</label><div class="stat-value">' + totalItems + '</div></div><div class="location-stat"><label>Total Stock</label><div class="stat-value">' + totalStock + '</div></div><div class="location-stat"><label>Low Stock</label><div class="stat-value" style="color: ' + (lowStock > 0 ? '#dc3545' : '#28a745') + ';">' + lowStock + '</div></div><div class="location-stat"><label>Value</label><div class="stat-value">TZS ' + totalValue.toLocaleString() + '</div></div></div></div>';
                }).join('');
            }

            const activitiesDiv = document.getElementById('recentActivities');
            if (activities.length === 0) {
                activitiesDiv.innerHTML = '<p style="color: #666;">No recent activities</p>';
            } else {
                activitiesDiv.innerHTML = activities.slice(-10).reverse().map(activity => 
                    '<div style="padding: 10px; border-left: 3px solid #667eea; margin-bottom: 10px; background: #f8f9fa;"><small style="color: #666;">' + formatDate(activity.date) + '</small><br>' + activity.text + '</div>'
                ).join('');
            }
        }

        function addActivity(text) {
            activities.push({ text: text, date: new Date().toISOString() });
            if (activities.length > 100) activities = activities.slice(-100);
            saveData();
            updateDashboard();
        }

        function generateEODReport() {
            const reportDate = document.getElementById('reportDate').value;
            const reportLocation = document.getElementById('reportLocation').value;
            
            let filteredSales = sales;
            
            if (reportDate) {
                filteredSales = filteredSales.filter(s => 
                    new Date(s.date).toDateString() === new Date(reportDate).toDateString()
                );
            }
            
            if (reportLocation) {
                filteredSales = filteredSales.filter(s => s.location === reportLocation);
            }

            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const totalDiscount = filteredSales.reduce((sum, sale) => sum + (sale.discountAmount || 0), 0);
            const totalItemsSold = filteredSales.reduce((sum, sale) => sum + sale.quantity, 0);
            const grossRevenue = filteredSales.reduce((sum, sale) => sum + (sale.subtotal || sale.total), 0);

            const reportTitle = reportDate ? new Date(reportDate).toLocaleDateString() : 'All Time';
            const locationTitle = reportLocation || 'All Locations';

            let lowStockInventory = inventory.filter(item => item.quantity <= item.minStock);
            if (reportLocation) {
                lowStockInventory = lowStockInventory.filter(i => i.location === reportLocation);
            }

            const report = '<div style="padding: 30px; background: white;"><div style="text-align: center; margin-bottom: 30px;"><img src="logo.jpg" alt="WAWLYN Logo" style="max-width: 200px; margin-bottom: 20px;"><h1 style="color: #667eea;">WAWLYN Limited</h1><h2>End of Day Report</h2><p><strong>Date:</strong> ' + reportTitle + '</p><p><strong>Location:</strong> ' + locationTitle + '</p><p><strong>Generated:</strong> ' + formatDate(new Date().toISOString()) + '</p></div><div style="margin-bottom: 30px;"><h3>Sales Summary</h3><table style="width: 100%; border: 1px solid #ddd;"><tr><td style="padding: 10px;"><strong>Total Sales:</strong></td><td style="padding: 10px;">' + filteredSales.length + '</td></tr><tr><td style="padding: 10px;"><strong>Items Sold:</strong></td><td style="padding: 10px;">' + totalItemsSold + '</td></tr><tr><td style="padding: 10px;"><strong>Gross Revenue:</strong></td><td style="padding: 10px;">TZS ' + grossRevenue.toLocaleString() + '</td></tr><tr><td style="padding: 10px;"><strong>Total Discounts:</strong></td><td style="padding: 10px; color: #28a745;">-TZS ' + totalDiscount.toLocaleString() + '</td></tr><tr style="background: #f8f9fa;"><td style="padding: 10px;"><strong>Net Revenue:</strong></td><td style="padding: 10px;"><strong>TZS ' + totalRevenue.toLocaleString() + '</strong></td></tr></table></div>' + (filteredSales.length > 0 ? '<div style="margin-bottom: 30px;"><h3>Detailed Sales</h3><table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #667eea; color: white;"><th style="padding: 10px; border: 1px solid #ddd;">Date</th><th style="padding: 10px; border: 1px solid #ddd;">Item</th><th style="padding: 10px; border: 1px solid #ddd;">Qty</th><th style="padding: 10px; border: 1px solid #ddd;">Price</th><th style="padding: 10px; border: 1px solid #ddd;">Subtotal</th><th style="padding: 10px; border: 1px solid #ddd;">Discount</th><th style="padding: 10px; border: 1px solid #ddd;">Total</th><th style="padding: 10px; border: 1px solid #ddd;">Location</th></tr></thead><tbody>' + filteredSales.map(sale => {
                const discountText = sale.discountAmount > 0 ? '-TZS ' + sale.discountAmount.toLocaleString() : '-';
                return '<tr><td style="padding: 10px; border: 1px solid #ddd;">' + formatDate(sale.date) + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + sale.name + ' - ' + sale.variant + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + sale.quantity + '</td><td style="padding: 10px; border: 1px solid #ddd;">TZS ' + sale.price.toLocaleString() + '</td><td style="padding: 10px; border: 1px solid #ddd;">TZS ' + (sale.subtotal || sale.total).toLocaleString() + '</td><td style="padding: 10px; border: 1px solid #ddd; color: #28a745;">' + discountText + '</td><td style="padding: 10px; border: 1px solid #ddd;"><strong>TZS ' + sale.total.toLocaleString() + '</strong></td><td style="padding: 10px; border: 1px solid #ddd;">' + sale.location + '</td></tr>';
            }).join('') + '</tbody></table></div>' : '<p style="text-align: center; color: #666;">No sales for this period/location</p>') + (lowStockInventory.length > 0 ? '<div style="margin-bottom: 30px;"><h3>Low Stock Alerts</h3><table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #ffc107;"><th style="padding: 10px; border: 1px solid #ddd;">Item</th><th style="padding: 10px; border: 1px solid #ddd;">Current Stock</th><th style="padding: 10px; border: 1px solid #ddd;">Min Stock</th><th style="padding: 10px; border: 1px solid #ddd;">Location</th></tr></thead><tbody>' + lowStockInventory.map(item => '<tr><td style="padding: 10px; border: 1px solid #ddd;">' + item.name + ' - ' + item.variant + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + item.quantity + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + item.minStock + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + item.location + '</td></tr>').join('') + '</tbody></table></div>' : '') + '</div>';

            document.getElementById('reportContainer').innerHTML = report;
            setTimeout(function() { window.print(); }, 500);
        }

        function generateInventoryReport() {
            const reportLocation = document.getElementById('reportLocation').value;
            let filteredInventory = inventory;
            
            if (reportLocation) {
                filteredInventory = filteredInventory.filter(i => i.location === reportLocation);
            }

            const locationTitle = reportLocation || 'All Locations';

            const report = '<div style="padding: 30px; background: white;"><div style="text-align: center; margin-bottom: 30px;"><img src="logo.jpg" alt="WAWLYN Logo" style="max-width: 200px; margin-bottom: 20px;"><h1 style="color: #667eea;">WAWLYN Limited</h1><h2>Full Inventory Report</h2><p><strong>Location:</strong> ' + locationTitle + '</p><p><strong>Generated:</strong> ' + formatDate(new Date().toISOString()) + '</p></div>' + (filteredInventory.length > 0 ? '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #667eea; color: white;"><th style="padding: 10px; border: 1px solid #ddd;">Name</th><th style="padding: 10px; border: 1px solid #ddd;">Variant</th><th style="padding: 10px; border: 1px solid #ddd;">Quantity</th><th style="padding: 10px; border: 1px solid #ddd;">Min Stock</th><th style="padding: 10px; border: 1px solid #ddd;">Location</th><th style="padding: 10px; border: 1px solid #ddd;">Price</th><th style="padding: 10px; border: 1px solid #ddd;">Value</th><th style="padding: 10px; border: 1px solid #ddd;">Date Added</th></tr></thead><tbody>' + filteredInventory.map(item => '<tr><td style="padding: 10px; border: 1px solid #ddd;">' + item.name + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + item.variant + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + item.quantity + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + item.minStock + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + item.location + '</td><td style="padding: 10px; border: 1px solid #ddd;">TZS ' + item.price.toLocaleString() + '</td><td style="padding: 10px; border: 1px solid #ddd;">TZS ' + (item.quantity * item.price).toLocaleString() + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + formatDate(item.dateAdded) + '</td></tr>').join('') + '</tbody></table><div style="margin-top: 30px; text-align: right;"><h3>Total Inventory Value: TZS ' + filteredInventory.reduce((sum, item) => sum + (item.quantity * item.price), 0).toLocaleString() + '</h3></div>' : '<p style="text-align: center; color: #666;">No inventory items for this location</p>') + '</div>';

            document.getElementById('reportContainer').innerHTML = report;
            setTimeout(function() { window.print(); }, 500);
        }

        function generateSalesReport() {
            const reportDate = document.getElementById('reportDate').value;
            const reportLocation = document.getElementById('reportLocation').value;
            
            let filteredSales = sales;
            
            if (reportDate) {
                filteredSales = filteredSales.filter(s => 
                    new Date(s.date).toDateString() === new Date(reportDate).toDateString()
                );
            }
            
            if (reportLocation) {
                filteredSales = filteredSales.filter(s => s.location === reportLocation);
            }

            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const reportTitle = reportDate ? new Date(reportDate).toLocaleDateString() : 'All Time';
            const locationTitle = reportLocation || 'All Locations';

            const report = '<div style="padding: 30px; background: white;"><div style="text-align: center; margin-bottom: 30px;"><img src="logo.jpg" alt="WAWLYN Logo" style="max-width: 200px; margin-bottom: 20px;"><h1 style="color: #667eea;">WAWLYN Limited</h1><h2>Sales Report</h2><p><strong>Period:</strong> ' + reportTitle + '</p><p><strong>Location:</strong> ' + locationTitle + '</p><p><strong>Generated:</strong> ' + formatDate(new Date().toISOString()) + '</p></div>' + (filteredSales.length > 0 ? '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #667eea; color: white;"><th style="padding: 10px; border: 1px solid #ddd;">Date</th><th style="padding: 10px; border: 1px solid #ddd;">Item</th><th style="padding: 10px; border: 1px solid #ddd;">Quantity</th><th style="padding: 10px; border: 1px solid #ddd;">Total</th><th style="padding: 10px; border: 1px solid #ddd;">Location</th></tr></thead><tbody>' + filteredSales.map(sale => '<tr><td style="padding: 10px; border: 1px solid #ddd;">' + formatDate(sale.date) + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + sale.name + ' - ' + sale.variant + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + sale.quantity + '</td><td style="padding: 10px; border: 1px solid #ddd;">TZS ' + sale.total.toLocaleString() + '</td><td style="padding: 10px; border: 1px solid #ddd;">' + sale.location + '</td></tr>').join('') + '</tbody></table><div style="margin-top: 30px; text-align: right;"><h3>Total Revenue: TZS ' + totalRevenue.toLocaleString() + '</h3></div>' : '<p style="text-align: center; color: #666;">No sales for this period/location</p>') + '</div>';

            document.getElementById('reportContainer').innerHTML = report;
            setTimeout(function() { window.print(); }, 500);
        }

        function downloadTemplate() {
            const csv = 'Name,Variant,Quantity,Min Stock,Status,Location,Price\niPhone 14 Pro,128GB Black,10,5,In Stock,Main Store,45000\niPhone 14,64GB White,8,3,In Stock,Branch 1,35000\nSamsung Galaxy S23,256GB Gray,15,5,In Stock,Main Store,40000';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inventory_template.csv';
            a.click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                let imported = 0;
                let skipped = 0;
                let errors = [];

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (!line) {
                        continue;
                    }

                    const parts = line.split(',').map(p => p.trim());

                    if (parts.length < 7) {
                        errors.push('Line ' + i + ': Not enough columns (found ' + parts.length + ', need 7)');
                        skipped++;
                        continue;
                    }

                    const name = parts[0];
                    const variant = parts[1];
                    const quantity = parts[2];
                    const minStock = parts[3];
                    const status = parts[4];
                    const location = parts[5];
                    const price = parts[6];
                    
                    if (!name || !variant || !location) {
                        errors.push('Line ' + i + ': Missing required fields (name, variant, or location)');
                        skipped++;
                        continue;
                    }

                    try {
                        const product = getOrCreateProduct(name, variant);
                        
                        const existingItem = inventory.find(item => 
                            item.productId === product.productId && item.location === location
                        );
                        
                        if (existingItem) {
                            skipped++;
                            continue;
                        }

                        inventory.push({
                            id: Date.now() + i + Math.random(),
                            productId: product.productId,
                            name: name,
                            variant: variant,
                            quantity: parseInt(quantity) || 0,
                            minStock: parseInt(minStock) || 0,
                            location: location,
                            price: parseFloat(price) || 0,
                            dateAdded: new Date().toISOString()
                        });
                        imported++;
                    } catch (err) {
                        errors.push('Line ' + i + ': Error - ' + err.message);
                        skipped++;
                    }
                }

                saveData();
                addActivity('Imported ' + imported + ' items from CSV (' + skipped + ' skipped)');
                renderInventory();
                updateDashboard();
                updateSelects();
                
                let message = 'Import Complete!\n\n';
                message += '‚úÖ Successfully imported: ' + imported + ' items\n';
                if (skipped > 0) {
                    message += '‚ö†Ô∏è Skipped: ' + skipped + ' items\n\n';
                }
                if (errors.length > 0) {
                    message += 'Errors:\n';
                    errors.forEach(function(err) {
                        message += '- ' + err + '\n';
                    });
                }
                
                alert(message);
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function exportData() {
            const data = {
                inventory: inventory,
                productCatalog: productCatalog,
                sales: sales,
                transfers: transfers,
                activities: activities,
                exportDate: new Date().toISOString()
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'WAWLYN-backup-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            window.URL.revokeObjectURL(url);
            alert('Data exported successfully!');
        }

        function clearAllData() {
            const confirmText = 'DELETE ALL DATA';
            const userInput = prompt('‚ö†Ô∏è WARNING: This will delete ALL inventory, sales, and transfer records!\n\nType "' + confirmText + '" to confirm:');
            
            if (userInput === confirmText) {
                inventory = [];
                productCatalog = [];
                sales = [];
                transfers = [];
                activities = [];
                saveData();
                renderInventory();
                renderSales();
                renderTransfers();
                updateDashboard();
                updateSelects();
                alert('All data has been cleared!');
                location.reload();
            } else if (userInput !== null) {
                alert('Deletion cancelled - text did not match.');
            }
        }

        function saveData() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('productCatalog', JSON.stringify(productCatalog));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('transfers', JSON.stringify(transfers));
            localStorage.setItem('activities', JSON.stringify(activities));
        }
    </script>
</body>
</html>
